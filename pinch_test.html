<!DOCTYPE html>
<html>

<head>
   <title>Hand Input Module in A-Frame</title>
   <!-- Incluye la biblioteca principal de A-Frame -->
   <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
   <!-- Incluye aframe-extras para funcionalidades adicionales -->
   <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
</head>

<body>
   <!-- La escena principal de A-Frame -->
   <a-scene 
      xr-mode-ui="enabled: true; enterVRDisabled: false;"
      webxr="optionalFeatures: hand-tracking" 
      background="color: #444444">
      
      <!-- Un cubo interactivo colocado en la escena -->
      <a-box id="box" width="0.2" height="0.2" depth="0.2" position="0 1.2 -0.4" color="green"></a-box>

      <a-entity hand-skeleton></a-entity>
   </a-scene>

   <script>
       // Definimos las articulaciones de los dedos en orden para construir las manos
       const orderedJoints = [
           ["thumb-tip", "index-finger-tip", "middle-finger-tip", "ring-finger-tip", "pinky-finger-tip"] // Articulaciones principales
       ];

       // Define la distancia mínima para detectar un puño cerrado
       const fistDistance = 0.05;

       // Función para calcular la distancia entre dos puntos en 3D
       function calculateDistance(point1, point2) {
           return Math.sqrt((point1.x - point2.x) ** 2 + (point1.y - point2.y) ** 2 + (point1.z - point2.z) ** 2);
       }

       // Componente personalizado para manejar las manos
       AFRAME.registerComponent('hand-skeleton', {
           init: function () {
               this.referenceSpace = null; // Espacio de referencia para XR
               this.frame = null; // Referencia al marco XR actual
               this.spheres = {}; // Esferas para representar articulaciones de las manos
               this.box = document.getElementById('box'); // Referencia al cubo
           },

           // Método llamado en cada frame para actualizar la lógica del componente
           tick: function () {
               if (!this.frame) {
                   this.frame = this.el.sceneEl.frame; // Obtiene el marco XR
                   this.referenceSpace = this.el.sceneEl.renderer.xr.getReferenceSpace(); // Obtiene el espacio de referencia XR
               } else {
                   this.renderHandSkeleton(); // Renderiza las manos
                   this.detectFistGesture(); // Detecta el gesto de cerrar puño
               }
           },

           // Renderiza las articulaciones de las manos
           renderHandSkeleton: function () {
               const session = this.el.sceneEl.renderer.xr.getSession(); // Obtiene la sesión XR
               const inputSources = session.inputSources; // Fuentes de entrada XR
               if (!this.frame || !this.referenceSpace) {
                   return;
               }
               for (const inputSource of inputSources) {
                   if (inputSource.hand) { // Comprueba si la fuente de entrada tiene una mano
                       const hand = inputSource.hand;
                       const handedness = inputSource.handedness; // Determina si es mano derecha o izquierda
                       for (const finger of orderedJoints) {
                           for (const jointName of finger) {
                               const joint = hand.get(jointName);
                               if (joint) {
                                   const jointPose = this.frame.getJointPose(joint, this.referenceSpace);
                                   if (jointPose != null) {
                                       const position = jointPose.transform.position;
                                       if (!this.spheres[handedness + '_' + jointName]) {
                                           this.spheres[handedness + '_' + jointName] = this.drawSphere(jointPose.radius, position);
                                       } else {
                                           this.spheres[handedness + '_' + jointName].object3D.position.set(position.x, position.y, position.z);
                                       }
                                   }
                               }
                           }
                       }
                   }
               }
           },

           // Detecta el gesto de cerrar el puño
           detectFistGesture: function () {
               const session = this.el.sceneEl.renderer.xr.getSession();
               const inputSources = session.inputSources;

               for (const inputSource of inputSources) {
                   if (inputSource.hand) {
                       const hand = inputSource.hand;
                       const handedness = inputSource.handedness; // Verifica si es mano derecha o izquierda

                       if (handedness === 'right') { // Detecta solo en la mano derecha
                           let allClose = true;

                           // Verifica las distancias entre el pulgar y los demás dedos
                           const thumbTip = this.frame.getJointPose(hand.get("thumb-tip"), this.referenceSpace);

                           if (thumbTip) {
                               for (let i = 1; i < orderedJoints[0].length; i++) {
                                   const fingerTip = this.frame.getJointPose(hand.get(orderedJoints[0][i]), this.referenceSpace);

                                   if (fingerTip) {
                                       const distance = calculateDistance(thumbTip.transform.position, fingerTip.transform.position);
                                       if (distance > fistDistance) {
                                           allClose = false; // Si algún dedo está lejos, no se cierra el puño
                                           break;
                                       }
                                   }
                               }
                           }

                           // Cambia el cubo a esfera si se cierra el puño
                           if (allClose) {
                               this.box.setAttribute('geometry', { primitive: 'sphere', radius: 0.15 });
                               this.box.setAttribute('color', 'yellow'); // Cambia el color a amarillo
                           } else {
                               this.box.setAttribute('geometry', { primitive: 'box', width: 0.2, height: 0.2, depth: 0.2 });
                               this.box.setAttribute('color', 'green'); // Restablece el color
                           }
                       }
                   }
               }
           },

           // Dibuja una esfera para representar una articulación de la mano
           drawSphere: function (radius, position) {
               const sphere = document.createElement('a-sphere');
               sphere.setAttribute('radius', radius);
               sphere.setAttribute('color', '#ffffff'); // Color blanco para las esferas
               sphere.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
               this.el.appendChild(sphere);
               return sphere;
           },

           // Elimina las esferas cuando el componente es destruido
           remove: function () {
               for (const jointName in this.spheres) {
                   this.spheres[jointName].parentNode.removeChild(this.spheres[jointName]);
               }
           },
       });
   </script>
</body>

</html>
