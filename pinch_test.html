<!DOCTYPE html>
<html>

<head>
   <title>Hand Pinch Interaction</title>
   <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
</head>

<body>
   <a-scene 
      xr-mode-ui="enabled: true; enterVRDisabled: false;" 
      webxr="optionalFeatures: hand-tracking" 
      background="color: #444444">
      
      <a-entity hand-skeleton></a-entity>
   </a-scene>

   <script>
       const pinchDistance = 0.02;
       const orderedJoints = [
           ["wrist"],
           ["thumb-metacarpal", "thumb-phalanx-proximal", "thumb-phalanx-distal", "thumb-tip"],
           ["index-finger-metacarpal", "index-finger-phalanx-proximal", "index-finger-phalanx-intermediate", "index-finger-phalanx-distal", "index-finger-tip"],
           ["middle-finger-metacarpal", "middle-finger-phalanx-proximal", "middle-finger-phalanx-intermediate", "middle-finger-phalanx-distal", "middle-finger-tip"],
           ["ring-finger-metacarpal", "ring-finger-phalanx-proximal", "ring-finger-phalanx-intermediate", "ring-finger-phalanx-distal", "ring-finger-tip"],
           ["pinky-finger-metacarpal", "pinky-finger-phalanx-proximal", "pinky-finger-phalanx-intermediate", "pinky-finger-phalanx-distal", "pinky-finger-tip"],
       ];

       function calculateDistance(point1, point2) {
           return Math.sqrt((point1.x - point2.x) ** 2 + (point1.y - point2.y) ** 2 + (point1.z - point2.z) ** 2);
       }

       AFRAME.registerComponent('hand-skeleton', {
           init: function () {
               this.frame = null;
               this.referenceSpace = null;
               this.rightPinching = false;
               this.leftPinching = false;
               this.selectedObject = null;
               this.spheres = {}; // Almacena las esferas de las articulaciones
               this.renderHandSkeleton(); // Renderiza las manos al inicio
           },

           tick: function () {
               if (!this.frame) {
                   this.frame = this.el.sceneEl.frame;
                   this.referenceSpace = this.el.sceneEl.renderer.xr.getReferenceSpace();
               } else {
                   this.renderHandSkeleton(); // Actualiza la posici√≥n de las articulaciones
                   this.detectGestures();
                   if (this.leftPinching && this.selectedObject) {
                       this.moveSelectedObject();
                   }
               }
           },

           drawSphere: function (radius, position) {
               const sphere = document.createElement('a-sphere');
               sphere.setAttribute('radius', radius || 0.008);
               sphere.setAttribute('color', 'cyan');
               sphere.object3D.position.set(position.x, position.y, position.z);
               this.el.sceneEl.appendChild(sphere);
               return sphere;
           },

           renderHandSkeleton: function () {
               const session = this.el.sceneEl.renderer.xr.getSession();
               if (!session || !this.frame || !this.referenceSpace) {
                   return;
               }

               const inputSources = session.inputSources;
               for (const inputSource of inputSources) {
                   if (inputSource.hand) {
                       const hand = inputSource.hand;
                       const handedness = inputSource.handedness;
                       for (const finger of orderedJoints) {
                           for (const jointName of finger) {
                               const joint = hand.get(jointName);
                               if (joint) {
                                   const jointPose = this.frame.getJointPose(joint, this.referenceSpace);
                                   if (jointPose) {
                                       const position = jointPose.transform.position;
                                       if (!this.spheres[handedness + '_' + jointName]) {
                                           this.spheres[handedness + '_' + jointName] = this.drawSphere(jointPose.radius, position);
                                       } else {
                                           this.spheres[handedness + '_' + jointName].object3D.position.set(position.x, position.y, position.z);
                                       }
                                   }
                               }
                           }
                       }
                   }
               }
           },

           detectGestures: function () {
               const session = this.el.sceneEl.renderer.xr.getSession();
               const inputSources = session.inputSources;

               let rightPinching = false;
               let leftPinching = false;

               for (const inputSource of inputSources) {
                   if (inputSource.hand) {
                       const thumbTip = this.frame.getJointPose(inputSource.hand.get("thumb-tip"), this.referenceSpace);
                       const indexTip = this.frame.getJointPose(inputSource.hand.get("index-finger-tip"), this.referenceSpace);

                       if (thumbTip && indexTip) {
                           const distance = calculateDistance(thumbTip.transform.position, indexTip.transform.position);

                           if (distance < pinchDistance) {
                               if (inputSource.handedness === 'right') {
                                   rightPinching = true;
                                   if (!this.rightPinching) {
                                       this.createBoxAtHand(inputSource.hand);
                                   }
                               } else if (inputSource.handedness === 'left') {
                                   leftPinching = true;
                                   if (!this.leftPinching) {
                                       this.selectObjectAtHand(inputSource.hand);
                                   }
                               }
                           }
                       }
                   }
               }

               this.rightPinching = rightPinching;
               this.leftPinching = leftPinching;
           },

           createBoxAtHand: function (hand) {
               const indexTip = this.frame.getJointPose(hand.get("index-finger-tip"), this.referenceSpace);

               if (indexTip) {
                   const position = indexTip.transform.position;
                   const box = document.createElement('a-box');
                   box.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
                   box.setAttribute('width', '0.2');
                   box.setAttribute('height', '0.2');
                   box.setAttribute('depth', '0.2');
                   box.setAttribute('color', 'green');
                   box.classList.add('movable'); // Marcamos los cubos creados
                   this.el.sceneEl.appendChild(box);
               }
           },

           selectObjectAtHand: function (hand) {
               const indexTip = this.frame.getJointPose(hand.get("index-finger-tip"), this.referenceSpace);

               if (indexTip) {
                   const position = indexTip.transform.position;

                   let closestObject = null;
                   let minDistance = Infinity;

                   this.el.sceneEl.querySelectorAll('.movable').forEach((box) => {
                       const boxPosition = box.object3D.position;
                       const distance = calculateDistance(position, boxPosition);

                       if (distance < minDistance) {
                           minDistance = distance;
                           closestObject = box;
                       }
                   });

                   if (minDistance < 0.1) {
                       this.selectedObject = closestObject;
                   }
               }
           },

           moveSelectedObject: function () {
               const session = this.el.sceneEl.renderer.xr.getSession();
               const leftHand = Array.from(session.inputSources).find(input => input.handedness === 'left');
               const indexTip = this.frame.getJointPose(leftHand.hand.get("index-finger-tip"), this.referenceSpace);

               if (indexTip && this.selectedObject) {
                   const position = indexTip.transform.position;
                   this.selectedObject.object3D.position.set(position.x, position.y, position.z);
               }
           },
       });
   </script>
</body>

</html>
