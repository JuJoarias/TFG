<!DOCTYPE html>
<html>

<head>
   <title>Hand Components with Gesture Events</title>
   <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
</head>

<body>
   <a-scene 
      xr-mode-ui="enabled: true; enterVRDisabled: false;" 
      webxr="optionalFeatures: hand-tracking" 
      background="color: #444444">
      
      <!-- Componentes de manos -->
      <a-entity manos="hand: left"></a-entity>
      <a-entity manos="hand: right"></a-entity>

      <!-- Componentes detectores -->
      <a-entity detector="target: #left-text"></a-entity>
      <a-entity detector="target: #right-text"></a-entity>

      <!-- Entidades de texto -->
      <a-entity id="left-text" position="-1 1 -3" text="value: Esperando gesto izquierdo...; color: #FFF"></a-entity>
      <a-entity id="right-text" position="1 1 -3" text="value: Esperando gesto derecho...; color: #FFF"></a-entity>
   </a-scene>

   <script>
      const pinchDistance = 0.02;

      // Componente `manos`
      AFRAME.registerComponent('manos', {
         schema: {
            hand: { type: 'string', default: 'left' } // izquierda o derecha
         },

         init: function () {
            this.frame = null;
            this.referenceSpace = null;
            this.pinchState = false; // Estado del pinch actual
         },

         tick: function () {
            if (!this.frame) {
               this.frame = this.el.sceneEl.frame;
               this.referenceSpace = this.el.sceneEl.renderer.xr.getReferenceSpace();
            } else {
               this.detectGesture();
            }
         },

         detectGesture: function () {
            const session = this.el.sceneEl.renderer.xr.getSession();
            const inputSources = session.inputSources;

            for (const inputSource of inputSources) {
               if (inputSource.handedness === this.data.hand && inputSource.hand) {
                  const thumbTip = this.frame.getJointPose(inputSource.hand.get("thumb-tip"), this.referenceSpace);
                  const indexTip = this.frame.getJointPose(inputSource.hand.get("index-finger-tip"), this.referenceSpace);

                  if (thumbTip && indexTip) {
                     const distance = Math.sqrt(
                        Math.pow(thumbTip.transform.position.x - indexTip.transform.position.x, 2) +
                        Math.pow(thumbTip.transform.position.y - indexTip.transform.position.y, 2) +
                        Math.pow(thumbTip.transform.position.z - indexTip.transform.position.z, 2)
                     );

                     // Evento de inicio del gesto
                     if (distance < pinchDistance && !this.pinchState) {
                        this.pinchState = true;
                        this.el.emit('pinchstart', { hand: this.data.hand }); // Emite evento de inicio
                     } 
                     // Evento de fin del gesto
                     else if (distance >= pinchDistance && this.pinchState) {
                        this.pinchState = false;
                        this.el.emit('pinchend', { hand: this.data.hand }); // Emite evento de fin
                     }
                  }
               }
            }
         }
      });

      // Componente `detector`
      AFRAME.registerComponent('detector', {
         schema: {
            target: { type: 'selector' } // Selección del texto a actualizar
         },

         init: function () {
            this.el.sceneEl.addEventListener('pinchstart', (evt) => {
               if (evt.detail.hand === 'left') {
                  this.updateText(this.data.target, "¡Inicio de gesto izquierdo!");
               } else if (evt.detail.hand === 'right') {
                  this.updateText(this.data.target, "¡Inicio de gesto derecho!");
               }
            });

            this.el.sceneEl.addEventListener('pinchend', (evt) => {
               if (evt.detail.hand === 'left') {
                  this.updateText(this.data.target, "¡Fin de gesto izquierdo!");
               } else if (evt.detail.hand === 'right') {
                  this.updateText(this.data.target, "¡Fin de gesto derecho!");
               }
            });
         },

         updateText: function (target, message) {
            if (target) {
               target.setAttribute('text', `value: ${message}; color: #FFF`);
            }
         }
      });
   </script>
</body>

</html>
