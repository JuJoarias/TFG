<!DOCTYPE html>
<html>

<head>
   <title>Hand Components with Gesture Events</title>
   <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
</head>

<body>
   <a-scene 
      xr-mode-ui="enabled: true; enterVRDisabled: false;" 
      webxr="optionalFeatures: hand-tracking" 
      background="color: #444444">

      <!-- Entidades de texto -->
      <a-entity id="left-text" position="-1 1 -1" text="value: Esperando gesto izquierdo...; color: #FFF"></a-entity>
      <a-entity id="right-text" position="1 1 -1" text="value: Esperando gesto derecho...; color: #FFF"></a-entity>
      
      <!-- Componentes de manos -->
      <a-entity manos="hand: left"></a-entity>
      <a-entity manos="hand: right"></a-entity>

      <!-- Componentes detectores -->
      <a-entity detector="target: #left-text"></a-entity>
      <a-entity detector="target: #right-text"></a-entity>
   </a-scene>

   <script>
      const pinchDistance = 0.02;
      const orderedJoints = [
         ["thumb-tip", "thumb-phalanx-distal", "thumb-phalanx-proximal", "thumb-metacarpal"],
         ["index-finger-tip", "index-finger-phalanx-distal", "index-finger-phalanx-proximal", "index-finger-metacarpal"],
         ["middle-finger-tip", "middle-finger-phalanx-distal", "middle-finger-phalanx-proximal", "middle-finger-metacarpal"],
         ["ring-finger-tip", "ring-finger-phalanx-distal", "ring-finger-phalanx-proximal", "ring-finger-metacarpal"],
         ["pinky-finger-tip", "pinky-finger-phalanx-distal", "pinky-finger-phalanx-proximal", "pinky-finger-metacarpal"]
      ];

      // Componente `manos`
      AFRAME.registerComponent('manos', {
         schema: {
            hand: { type: 'string', default: 'left' } // izquierda o derecha
         },

         init: function () {
            this.frame = null;
            this.referenceSpace = null;
            this.pinchState = false; // Estado del pinch actual
            this.spheres = {}; // Almacena las esferas de las articulaciones
         },

         tick: function () {
            if (!this.frame) {
               this.frame = this.el.sceneEl.frame;
               this.referenceSpace = this.el.sceneEl.renderer.xr.getReferenceSpace();
            } else {
               this.detectGesture();
               this.renderHandSkeleton();
            }
         },

         detectGesture: function () {
            const session = this.el.sceneEl.renderer.xr.getSession();
            const inputSources = session.inputSources;

            for (const inputSource of inputSources) {
               if (inputSource.handedness === this.data.hand && inputSource.hand) {
                  const thumbTip = this.frame.getJointPose(inputSource.hand.get("thumb-tip"), this.referenceSpace);
                  const indexTip = this.frame.getJointPose(inputSource.hand.get("index-finger-tip"), this.referenceSpace);

                  if (thumbTip && indexTip) {
                     const distance = Math.sqrt(
                        Math.pow(thumbTip.transform.position.x - indexTip.transform.position.x, 2) +
                        Math.pow(thumbTip.transform.position.y - indexTip.transform.position.y, 2) +
                        Math.pow(thumbTip.transform.position.z - indexTip.transform.position.z, 2)
                     );

                     // Evento de inicio del gesto
                     if (distance < pinchDistance && !this.pinchState) {
                        this.pinchState = true;
                        this.el.emit('pinchstart', { hand: this.data.hand }); // Emite evento de inicio
                     } 
                     // Evento de fin del gesto
                     else if (distance >= pinchDistance && this.pinchState) {
                        this.pinchState = false;
                        this.el.emit('pinchend', { hand: this.data.hand }); // Emite evento de fin
                     }
                  }
               }
            }
         },

         drawSphere: function (radius, position) {
            const sphere = document.createElement('a-sphere');
            sphere.setAttribute('radius', radius || 0.008);
            sphere.setAttribute('color', 'white');
            sphere.object3D.position.set(position.x, position.y, position.z);
            this.el.sceneEl.appendChild(sphere);
            return sphere;
         },

         renderHandSkeleton: function () {
            const session = this.el.sceneEl.renderer.xr.getSession();
            if (!session || !this.frame || !this.referenceSpace) {
               return;
            }

            const inputSources = session.inputSources;
            for (const inputSource of inputSources) {
               if (inputSource.hand) {
                  const hand = inputSource.hand;
                  const handedness = inputSource.handedness; // Mano derecha o izquierda
                  for (const finger of orderedJoints) {
                     for (const jointName of finger) {
                        const joint = hand.get(jointName);
                        if (joint) {
                           const jointPose = this.frame.getJointPose(joint, this.referenceSpace);
                           if (jointPose) {
                              const position = jointPose.transform.position;
                              if (!this.spheres[handedness + '_' + jointName]) {
                                 this.spheres[handedness + '_' + jointName] = this.drawSphere(jointPose.radius, position);
                              } else {
                                 this.spheres[handedness + '_' + jointName].object3D.position.set(position.x, position.y, position.z);
                              }
                           }
                        }
                     }
                  }
               }
            }
         }
      });

      // Componente `detector`
      AFRAME.registerComponent('detector', {
         schema: {
            target: { type: 'selector' } // Selección del texto a actualizar
         },

         init: function () {
            this.el.sceneEl.addEventListener('pinchstart', (evt) => {
               if (evt.detail.hand === 'left') {
                  this.updateText(this.data.target, "¡Inicio de gesto izquierdo!");
               } else if (evt.detail.hand === 'right') {
                  this.updateText(this.data.target, "¡Inicio de gesto derecho!");
               }
            });

            this.el.sceneEl.addEventListener('pinchend', (evt) => {
               if (evt.detail.hand === 'left') {
                  this.updateText(this.data.target, "¡Fin de gesto izquierdo!");
               } else if (evt.detail.hand === 'right') {
                  this.updateText(this.data.target, "¡Fin de gesto derecho!");
               }
            });
         },

         updateText: function (target, message) {
            if (target) {
               target.setAttribute('text', `value: ${message}; color: #FFF`);
            }
         }
      });
   </script>
</body>

</html>
